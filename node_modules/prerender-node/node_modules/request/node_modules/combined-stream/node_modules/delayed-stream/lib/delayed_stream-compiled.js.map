{"version":3,"sources":["delayed_stream.js"],"names":[],"mappings":"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","file":"delayed_stream-compiled.js","sourcesContent":["var Stream = require('stream').Stream;\nvar util = require('util');\n\nmodule.exports = DelayedStream;\nfunction DelayedStream() {\n  this.source = null;\n  this.dataSize = 0;\n  this.maxDataSize = 1024 * 1024;\n  this.pauseStream = true;\n\n  this._maxDataSizeExceeded = false;\n  this._released = false;\n  this._bufferedEvents = [];\n}\nutil.inherits(DelayedStream, Stream);\n\nDelayedStream.create = function(source, options) {\n  var delayedStream = new this();\n\n  options = options || {};\n  for (var option in options) {\n    delayedStream[option] = options[option];\n  }\n\n  delayedStream.source = source;\n\n  var realEmit = source.emit;\n  source.emit = function() {\n    delayedStream._handleEmit(arguments);\n    return realEmit.apply(source, arguments);\n  };\n\n  source.on('error', function() {});\n  if (delayedStream.pauseStream) {\n    source.pause();\n  }\n\n  return delayedStream;\n};\n\nObject.defineProperty(DelayedStream.prototype, 'readable', {\n  configurable: true,\n  enumerable: true,\n  get: function() {\n    return this.source.readable;\n  }\n});\n\nDelayedStream.prototype.setEncoding = function() {\n  return this.source.setEncoding.apply(this.source, arguments);\n};\n\nDelayedStream.prototype.resume = function() {\n  if (!this._released) {\n    this.release();\n  }\n\n  this.source.resume();\n};\n\nDelayedStream.prototype.pause = function() {\n  this.source.pause();\n};\n\nDelayedStream.prototype.release = function() {\n  this._released = true;\n\n  this._bufferedEvents.forEach(function(args) {\n    this.emit.apply(this, args);\n  }.bind(this));\n  this._bufferedEvents = [];\n};\n\nDelayedStream.prototype.pipe = function() {\n  var r = Stream.prototype.pipe.apply(this, arguments);\n  this.resume();\n  return r;\n};\n\nDelayedStream.prototype._handleEmit = function(args) {\n  if (this._released) {\n    this.emit.apply(this, args);\n    return;\n  }\n\n  if (args[0] === 'data') {\n    this.dataSize += args[1].length;\n    this._checkIfMaxDataSizeExceeded();\n  }\n\n  this._bufferedEvents.push(args);\n};\n\nDelayedStream.prototype._checkIfMaxDataSizeExceeded = function() {\n  if (this._maxDataSizeExceeded) {\n    return;\n  }\n\n  if (this.dataSize <= this.maxDataSize) {\n    return;\n  }\n\n  this._maxDataSizeExceeded = true;\n  var message =\n    'DelayedStream#maxDataSize of ' + this.maxDataSize + ' bytes exceeded.'\n  this.emit('error', new Error(message));\n};\n"]}