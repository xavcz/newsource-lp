{"version":3,"sources":["reader.js"],"names":[],"mappings":";;;;AAEA,IAAI,MAAM,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;;AAE/B,IAAI,IAAI,GAAG,OAAO,CAAC,SAAS,CAAC,CAAC;AAC9B,IAAI,MAAM,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC;;;;AAKjC,IAAI,mBAAmB,GAAG,MAAM,CAAC,mBAAmB,CAAC;;;;AAMrD,SAAS,MAAM,CAAC,IAAI,EAAE;AACpB,MAAI,CAAC,IAAI,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,EACjC,MAAM,IAAI,SAAS,CAAC,4BAA4B,CAAC,CAAC;;AAEpD,MAAI,CAAC,IAAI,GAAG,IAAI,CAAC;AACjB,MAAI,CAAC,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC;;;AAGzB,MAAI,CAAC,IAAI,GAAG,CAAC,CAAC;AACd,MAAI,CAAC,OAAO,GAAG,CAAC,CAAC;CAClB;;AAED,MAAM,CAAC,cAAc,CAAC,MAAM,CAAC,SAAS,EAAE,QAAQ,EAAE;AAChD,YAAU,EAAE,IAAI;AAChB,KAAG,EAAE,eAAY;AAAE,WAAQ,IAAI,CAAC,IAAI,CAAE;GAAE;CACzC,CAAC,CAAC;;AAEH,MAAM,CAAC,cAAc,CAAC,MAAM,CAAC,SAAS,EAAE,QAAQ,EAAE;AAChD,YAAU,EAAE,IAAI;AAChB,KAAG,EAAE,eAAY;AAAE,WAAQ,IAAI,CAAC,OAAO,CAAE;GAAE;CAC5C,CAAC,CAAC;;AAEH,MAAM,CAAC,cAAc,CAAC,MAAM,CAAC,SAAS,EAAE,QAAQ,EAAE;AAChD,KAAG,EAAE,eAAY;AAAE,WAAQ,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,OAAO,CAAE;GAAE;CACzD,CAAC,CAAC;;AAEH,MAAM,CAAC,cAAc,CAAC,MAAM,CAAC,SAAS,EAAE,QAAQ,EAAE;AAChD,KAAG,EAAE,eAAY;AAAE,WAAQ,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,CAAE;GAAE;CAC7D,CAAC,CAAC;;;;;;;;;AAUH,MAAM,CAAC,SAAS,CAAC,QAAQ,GAAG,UAAS,IAAI,EAAE;AACzC,MAAI,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,OAAO,GAAG,CAAC,EAC/B,OAAO,IAAI,CAAC;;AAEd,MAAI,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC;;AAEvC,MAAI,CAAC,IAAI,EACP,IAAI,CAAC,OAAO,IAAI,CAAC,CAAC;;AAEpB,SAAO,CAAC,CAAC;CACV,CAAC;;AAGF,MAAM,CAAC,SAAS,CAAC,IAAI,GAAG,YAAW;AACjC,SAAO,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;CAC5B,CAAC;;;;;;;;;;;;;AAcF,MAAM,CAAC,SAAS,CAAC,UAAU,GAAG,UAAS,MAAM,EAAE;AAC7C,MAAI,MAAM,KAAK,SAAS,EACtB,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC;;AAExB,MAAI,MAAM,IAAI,IAAI,CAAC,KAAK,EACtB,OAAO,IAAI,CAAC;;AAEd,MAAI,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC,GAAG,IAAI,CAAC;AACtC,MAAI,IAAI,KAAK,IAAI,EACf,OAAO,IAAI,CAAC;;AAEd,MAAI,CAAC,IAAI,GAAG,IAAI,CAAA,IAAK,IAAI,EAAE;AACzB,QAAI,IAAI,IAAI,CAAC;;AAEb,QAAI,IAAI,IAAI,CAAC,EACX,MAAM,mBAAmB,CAAC,iCAAiC,CAAC,CAAC;;AAE/D,QAAI,IAAI,GAAG,CAAC,EACV,MAAM,mBAAmB,CAAC,mBAAmB,CAAC,CAAC;;AAEjD,QAAI,IAAI,CAAC,KAAK,GAAG,MAAM,GAAG,IAAI,EAC5B,OAAO,IAAI,CAAC;;AAEd,QAAI,CAAC,IAAI,GAAG,CAAC,CAAC;AACd,SAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,EAAE,CAAC,EAAE,EAC3B,IAAI,CAAC,IAAI,GAAG,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,CAAA,IAAK,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC,GAAG,IAAI,CAAA,AAAC,CAAC;GAE/D,MAAM;;AAEL,QAAI,CAAC,IAAI,GAAG,IAAI,CAAC;GAClB;;AAED,SAAO,MAAM,CAAC;CACf,CAAC;;;;;;;;;AAUF,MAAM,CAAC,SAAS,CAAC,YAAY,GAAG,UAAS,GAAG,EAAE;AAC5C,MAAI,GAAG,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;AACtB,MAAI,GAAG,KAAK,IAAI,EACd,OAAO,IAAI,CAAC;AACd,MAAI,GAAG,KAAK,SAAS,IAAI,GAAG,KAAK,GAAG,EAClC,MAAM,mBAAmB,CAAC,aAAa,GAAG,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC,GAChC,UAAU,GAAG,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;;AAE3D,MAAI,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,GAAG,CAAC,CAAC,CAAC;AAC1C,MAAI,CAAC,KAAK,IAAI,EACZ,OAAO,IAAI,CAAC;;AAEd,MAAI,CAAC,OAAO,GAAG,CAAC,CAAC;AACjB,SAAO,GAAG,CAAC;CACZ,CAAC;;AAGF,MAAM,CAAC,SAAS,CAAC,OAAO,GAAG,YAAW;AACpC,SAAO,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;CACpC,CAAC;;AAGF,MAAM,CAAC,SAAS,CAAC,WAAW,GAAG,YAAW;AACxC,SAAQ,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,KAAK,GAAG,IAAI,CAAE;CAC3D,CAAC;;AAGF,MAAM,CAAC,SAAS,CAAC,eAAe,GAAG,YAAW;AAC5C,SAAO,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;CACxC,CAAC;;AAGF,MAAM,CAAC,SAAS,CAAC,UAAU,GAAG,UAAS,GAAG,EAAE,MAAM,EAAE;AAClD,MAAI,CAAC,GAAG,EACN,GAAG,GAAG,IAAI,CAAC,WAAW,CAAC;;AAEzB,MAAI,CAAC,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;AACpB,MAAI,CAAC,KAAK,IAAI,EACZ,OAAO,IAAI,CAAC;;AAEd,MAAI,CAAC,KAAK,GAAG,EACX,MAAM,mBAAmB,CAAC,aAAa,GAAG,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC,GAChC,UAAU,GAAG,CAAC,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;;AAEzD,MAAI,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,GAAG,CAAC,CAAC,CAAC;;AAE1C,MAAI,CAAC,KAAK,IAAI,EACZ,OAAO,IAAI,CAAC;;AAEd,MAAI,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,KAAK,GAAG,CAAC,EAC9B,OAAO,IAAI,CAAC;;AAEd,MAAI,CAAC,OAAO,GAAG,CAAC,CAAC;;AAEjB,MAAI,IAAI,CAAC,MAAM,KAAK,CAAC,EACnB,OAAO,MAAM,GAAG,IAAI,MAAM,CAAC,CAAC,CAAC,GAAG,EAAE,CAAC;;AAErC,MAAI,GAAG,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC;AACpE,MAAI,CAAC,OAAO,IAAI,IAAI,CAAC,MAAM,CAAC;;AAE5B,SAAO,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;CAC5C,CAAC;;AAEF,MAAM,CAAC,SAAS,CAAC,OAAO,GAAG,UAAS,GAAG,EAAE;AACvC,MAAI,CAAC,GAAG,EACN,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC;;AAEjB,MAAI,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;AACnC,MAAI,CAAC,KAAK,IAAI,EACZ,OAAO,IAAI,CAAC;;AAEd,MAAI,MAAM,GAAG,EAAE,CAAC;AAChB,MAAI,KAAK,GAAG,CAAC,CAAC;;AAEd,OAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AACjC,QAAI,IAAI,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC;;AAEvB,SAAK,KAAK,CAAC,CAAC;AACZ,SAAK,IAAI,IAAI,GAAG,IAAI,CAAC;AACrB,QAAI,CAAC,IAAI,GAAG,IAAI,CAAA,IAAK,CAAC,EAAE;AACtB,YAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;AACnB,WAAK,GAAG,CAAC,CAAC;KACX;GACF;;AAED,OAAK,GAAG,MAAM,CAAC,KAAK,EAAE,CAAC;AACvB,QAAM,CAAC,OAAO,CAAC,KAAK,GAAG,EAAE,CAAC,CAAC;AAC3B,QAAM,CAAC,OAAO,CAAC,AAAC,KAAK,GAAG,EAAE,IAAK,CAAC,CAAC,CAAC;;AAElC,SAAO,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;CACzB,CAAC;;AAGF,MAAM,CAAC,SAAS,CAAC,QAAQ,GAAG,UAAS,GAAG,EAAE;AACxC,QAAM,CAAC,EAAE,CAAC,GAAG,KAAK,SAAS,CAAC,CAAC;;AAE7B,MAAI,CAAC,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;;AAEpB,MAAI,CAAC,KAAK,IAAI,EACZ,OAAO,IAAI,CAAC;;AAEd,MAAI,CAAC,KAAK,GAAG,EACX,MAAM,mBAAmB,CAAC,aAAa,GAAG,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC,GAChC,UAAU,GAAG,CAAC,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;;AAEzD,MAAI,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,GAAG,CAAC,CAAC,CAAC;AAC1C,MAAI,CAAC,KAAK,IAAI,EACZ,OAAO,IAAI,CAAC;;AAEd,MAAI,IAAI,CAAC,MAAM,GAAG,CAAC,EACjB,MAAM,mBAAmB,CAAC,oBAAoB,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC;;AAEhE,MAAI,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,KAAK,GAAG,CAAC,EAC9B,OAAO,IAAI,CAAC;AACd,MAAI,CAAC,OAAO,GAAG,CAAC,CAAC;;AAEjB,MAAI,EAAE,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;AACjC,MAAI,KAAK,GAAG,CAAC,CAAC;;AAEd,OAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AACpC,SAAK,KAAK,CAAC,CAAC;AACZ,SAAK,IAAK,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC,GAAG,IAAI,AAAC,CAAC;GAC7C;;AAED,MAAI,CAAC,EAAE,GAAG,IAAI,CAAA,IAAK,IAAI,IAAI,CAAC,KAAK,CAAC,EAChC,KAAK,IAAK,CAAC,IAAK,CAAC,GAAG,CAAC,AAAC,AAAC,CAAC;;AAE1B,SAAO,KAAK,IAAI,CAAC,CAAC;CACnB,CAAC;;;;AAMF,MAAM,CAAC,OAAO,GAAG,MAAM,CAAC","file":"reader-compiled.js","sourcesContent":["// Copyright 2011 Mark Cavage <mcavage@gmail.com> All rights reserved.\n\nvar assert = require('assert');\n\nvar ASN1 = require('./types');\nvar errors = require('./errors');\n\n\n///--- Globals\n\nvar newInvalidAsn1Error = errors.newInvalidAsn1Error;\n\n\n\n///--- API\n\nfunction Reader(data) {\n  if (!data || !Buffer.isBuffer(data))\n    throw new TypeError('data must be a node Buffer');\n\n  this._buf = data;\n  this._size = data.length;\n\n  // These hold the \"current\" state\n  this._len = 0;\n  this._offset = 0;\n}\n\nObject.defineProperty(Reader.prototype, 'length', {\n  enumerable: true,\n  get: function () { return (this._len); }\n});\n\nObject.defineProperty(Reader.prototype, 'offset', {\n  enumerable: true,\n  get: function () { return (this._offset); }\n});\n\nObject.defineProperty(Reader.prototype, 'remain', {\n  get: function () { return (this._size - this._offset); }\n});\n\nObject.defineProperty(Reader.prototype, 'buffer', {\n  get: function () { return (this._buf.slice(this._offset)); }\n});\n\n\n/**\n * Reads a single byte and advances offset; you can pass in `true` to make this\n * a \"peek\" operation (i.e., get the byte, but don't advance the offset).\n *\n * @param {Boolean} peek true means don't move offset.\n * @return {Number} the next byte, null if not enough data.\n */\nReader.prototype.readByte = function(peek) {\n  if (this._size - this._offset < 1)\n    return null;\n\n  var b = this._buf[this._offset] & 0xff;\n\n  if (!peek)\n    this._offset += 1;\n\n  return b;\n};\n\n\nReader.prototype.peek = function() {\n  return this.readByte(true);\n};\n\n\n/**\n * Reads a (potentially) variable length off the BER buffer.  This call is\n * not really meant to be called directly, as callers have to manipulate\n * the internal buffer afterwards.\n *\n * As a result of this call, you can call `Reader.length`, until the\n * next thing called that does a readLength.\n *\n * @return {Number} the amount of offset to advance the buffer.\n * @throws {InvalidAsn1Error} on bad ASN.1\n */\nReader.prototype.readLength = function(offset) {\n  if (offset === undefined)\n    offset = this._offset;\n\n  if (offset >= this._size)\n    return null;\n\n  var lenB = this._buf[offset++] & 0xff;\n  if (lenB === null)\n    return null;\n\n  if ((lenB & 0x80) == 0x80) {\n    lenB &= 0x7f;\n\n    if (lenB == 0)\n      throw newInvalidAsn1Error('Indefinite length not supported');\n\n    if (lenB > 4)\n      throw newInvalidAsn1Error('encoding too long');\n\n    if (this._size - offset < lenB)\n      return null;\n\n    this._len = 0;\n    for (var i = 0; i < lenB; i++)\n      this._len = (this._len << 8) + (this._buf[offset++] & 0xff);\n\n  } else {\n    // Wasn't a variable length\n    this._len = lenB;\n  }\n\n  return offset;\n};\n\n\n/**\n * Parses the next sequence in this BER buffer.\n *\n * To get the length of the sequence, call `Reader.length`.\n *\n * @return {Number} the sequence's tag.\n */\nReader.prototype.readSequence = function(tag) {\n  var seq = this.peek();\n  if (seq === null)\n    return null;\n  if (tag !== undefined && tag !== seq)\n    throw newInvalidAsn1Error('Expected 0x' + tag.toString(16) +\n                              ': got 0x' + seq.toString(16));\n\n  var o = this.readLength(this._offset + 1); // stored in `length`\n  if (o === null)\n    return null;\n\n  this._offset = o;\n  return seq;\n};\n\n\nReader.prototype.readInt = function() {\n  return this._readTag(ASN1.Integer);\n};\n\n\nReader.prototype.readBoolean = function() {\n  return (this._readTag(ASN1.Boolean) === 0 ? false : true);\n};\n\n\nReader.prototype.readEnumeration = function() {\n  return this._readTag(ASN1.Enumeration);\n};\n\n\nReader.prototype.readString = function(tag, retbuf) {\n  if (!tag)\n    tag = ASN1.OctetString;\n\n  var b = this.peek();\n  if (b === null)\n    return null;\n\n  if (b !== tag)\n    throw newInvalidAsn1Error('Expected 0x' + tag.toString(16) +\n                              ': got 0x' + b.toString(16));\n\n  var o = this.readLength(this._offset + 1); // stored in `length`\n\n  if (o === null)\n    return null;\n\n  if (this.length > this._size - o)\n    return null;\n\n  this._offset = o;\n\n  if (this.length === 0)\n    return retbuf ? new Buffer(0) : '';\n\n  var str = this._buf.slice(this._offset, this._offset + this.length);\n  this._offset += this.length;\n\n  return retbuf ? str : str.toString('utf8');\n};\n\nReader.prototype.readOID = function(tag) {\n  if (!tag)\n    tag = ASN1.OID;\n\n  var b = this.readString(tag, true);\n  if (b === null)\n    return null;\n\n  var values = [];\n  var value = 0;\n\n  for (var i = 0; i < b.length; i++) {\n    var byte = b[i] & 0xff;\n\n    value <<= 7;\n    value += byte & 0x7f;\n    if ((byte & 0x80) == 0) {\n      values.push(value);\n      value = 0;\n    }\n  }\n\n  value = values.shift();\n  values.unshift(value % 40);\n  values.unshift((value / 40) >> 0);\n\n  return values.join('.');\n};\n\n\nReader.prototype._readTag = function(tag) {\n  assert.ok(tag !== undefined);\n\n  var b = this.peek();\n\n  if (b === null)\n    return null;\n\n  if (b !== tag)\n    throw newInvalidAsn1Error('Expected 0x' + tag.toString(16) +\n                              ': got 0x' + b.toString(16));\n\n  var o = this.readLength(this._offset + 1); // stored in `length`\n  if (o === null)\n    return null;\n\n  if (this.length > 4)\n    throw newInvalidAsn1Error('Integer too long: ' + this.length);\n\n  if (this.length > this._size - o)\n    return null;\n  this._offset = o;\n\n  var fb = this._buf[this._offset];\n  var value = 0;\n\n  for (var i = 0; i < this.length; i++) {\n    value <<= 8;\n    value |= (this._buf[this._offset++] & 0xff);\n  }\n\n  if ((fb & 0x80) == 0x80 && i !== 4)\n    value -= (1 << (i * 8));\n\n  return value >> 0;\n};\n\n\n\n///--- Exported API\n\nmodule.exports = Reader;\n"]}