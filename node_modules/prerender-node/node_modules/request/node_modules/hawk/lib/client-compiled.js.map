{"version":3,"sources":["client.js"],"names":[],"mappings":"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","file":"client-compiled.js","sourcesContent":["// Load modules\r\n\r\nvar Url = require('url');\r\nvar Hoek = require('hoek');\r\nvar Cryptiles = require('cryptiles');\r\nvar Crypto = require('./crypto');\r\nvar Utils = require('./utils');\r\n\r\n\r\n// Declare internals\r\n\r\nvar internals = {};\r\n\r\n\r\n// Generate an Authorization header for a given request\r\n\r\n/*\r\n    uri: 'http://example.com/resource?a=b' or object from Url.parse()\r\n    method: HTTP verb (e.g. 'GET', 'POST')\r\n    options: {\r\n\r\n        // Required\r\n\r\n        credentials: {\r\n            id: 'dh37fgj492je',\r\n            key: 'aoijedoaijsdlaksjdl',\r\n            algorithm: 'sha256'                                 // 'sha1', 'sha256'\r\n        },\r\n\r\n        // Optional\r\n\r\n        ext: 'application-specific',                        // Application specific data sent via the ext attribute\r\n        timestamp: Date.now(),                              // A pre-calculated timestamp\r\n        nonce: '2334f34f',                                  // A pre-generated nonce\r\n        localtimeOffsetMsec: 400,                           // Time offset to sync with server time (ignored if timestamp provided)\r\n        payload: '{\"some\":\"payload\"}',                      // UTF-8 encoded string for body hash generation (ignored if hash provided)\r\n        contentType: 'application/json',                    // Payload content-type (ignored if hash provided)\r\n        hash: 'U4MKKSmiVxk37JCCrAVIjV=',                    // Pre-calculated payload hash\r\n        app: '24s23423f34dx',                               // Oz application id\r\n        dlg: '234sz34tww3sd'                                // Oz delegated-by application id\r\n    }\r\n*/\r\n\r\nexports.header = function (uri, method, options) {\r\n\r\n    var result = {\r\n        field: '',\r\n        artifacts: {}\r\n    };\r\n\r\n    // Validate inputs\r\n\r\n    if (!uri || (typeof uri !== 'string' && typeof uri !== 'object') ||\r\n        !method || typeof method !== 'string' ||\r\n        !options || typeof options !== 'object') {\r\n\r\n        result.err = 'Invalid argument type';\r\n        return result;\r\n    }\r\n\r\n    // Application time\r\n\r\n    var timestamp = options.timestamp || Utils.nowSecs(options.localtimeOffsetMsec);\r\n\r\n    // Validate credentials\r\n\r\n    var credentials = options.credentials;\r\n    if (!credentials ||\r\n        !credentials.id ||\r\n        !credentials.key ||\r\n        !credentials.algorithm) {\r\n\r\n        result.err = 'Invalid credential object';\r\n        return result;\r\n    }\r\n\r\n    if (Crypto.algorithms.indexOf(credentials.algorithm) === -1) {\r\n        result.err = 'Unknown algorithm';\r\n        return result;\r\n    }\r\n\r\n    // Parse URI\r\n\r\n    if (typeof uri === 'string') {\r\n        uri = Url.parse(uri);\r\n    }\r\n\r\n    // Calculate signature\r\n\r\n    var artifacts = {\r\n        ts: timestamp,\r\n        nonce: options.nonce || Cryptiles.randomString(6),\r\n        method: method,\r\n        resource: uri.pathname + (uri.search || ''),                            // Maintain trailing '?'\r\n        host: uri.hostname,\r\n        port: uri.port || (uri.protocol === 'http:' ? 80 : 443),\r\n        hash: options.hash,\r\n        ext: options.ext,\r\n        app: options.app,\r\n        dlg: options.dlg\r\n    };\r\n\r\n    result.artifacts = artifacts;\r\n\r\n    // Calculate payload hash\r\n\r\n    if (!artifacts.hash &&\r\n        (options.payload || options.payload === '')) {\r\n\r\n        artifacts.hash = Crypto.calculatePayloadHash(options.payload, credentials.algorithm, options.contentType);\r\n    }\r\n\r\n    var mac = Crypto.calculateMac('header', credentials, artifacts);\r\n\r\n    // Construct header\r\n\r\n    var hasExt = artifacts.ext !== null && artifacts.ext !== undefined && artifacts.ext !== '';       // Other falsey values allowed\r\n    var header = 'Hawk id=\"' + credentials.id +\r\n                 '\", ts=\"' + artifacts.ts +\r\n                 '\", nonce=\"' + artifacts.nonce +\r\n                 (artifacts.hash ? '\", hash=\"' + artifacts.hash : '') +\r\n                 (hasExt ? '\", ext=\"' + Hoek.escapeHeaderAttribute(artifacts.ext) : '') +\r\n                 '\", mac=\"' + mac + '\"';\r\n\r\n    if (artifacts.app) {\r\n        header += ', app=\"' + artifacts.app +\r\n                  (artifacts.dlg ? '\", dlg=\"' + artifacts.dlg : '') + '\"';\r\n    }\r\n\r\n    result.field = header;\r\n\r\n    return result;\r\n};\r\n\r\n\r\n// Validate server response\r\n\r\n/*\r\n    res:        node's response object\r\n    artifacts:  object received from header().artifacts\r\n    options: {\r\n        payload:    optional payload received\r\n        required:   specifies if a Server-Authorization header is required. Defaults to 'false'\r\n    }\r\n*/\r\n\r\nexports.authenticate = function (res, credentials, artifacts, options) {\r\n\r\n    artifacts = Hoek.clone(artifacts);\r\n    options = options || {};\r\n\r\n    if (res.headers['www-authenticate']) {\r\n\r\n        // Parse HTTP WWW-Authenticate header\r\n\r\n        var wwwAttributes = Utils.parseAuthorizationHeader(res.headers['www-authenticate'], ['ts', 'tsm', 'error']);\r\n        if (wwwAttributes instanceof Error) {\r\n            return false;\r\n        }\r\n\r\n        // Validate server timestamp (not used to update clock since it is done via the SNPT client)\r\n\r\n        if (wwwAttributes.ts) {\r\n            var tsm = Crypto.calculateTsMac(wwwAttributes.ts, credentials);\r\n            if (tsm !== wwwAttributes.tsm) {\r\n                return false;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Parse HTTP Server-Authorization header\r\n\r\n    if (!res.headers['server-authorization'] &&\r\n        !options.required) {\r\n\r\n        return true;\r\n    }\r\n\r\n    var attributes = Utils.parseAuthorizationHeader(res.headers['server-authorization'], ['mac', 'ext', 'hash']);\r\n    if (attributes instanceof Error) {\r\n        return false;\r\n    }\r\n\r\n    artifacts.ext = attributes.ext;\r\n    artifacts.hash = attributes.hash;\r\n\r\n    var mac = Crypto.calculateMac('response', credentials, artifacts);\r\n    if (mac !== attributes.mac) {\r\n        return false;\r\n    }\r\n\r\n    if (!options.payload &&\r\n        options.payload !== '') {\r\n\r\n        return true;\r\n    }\r\n\r\n    if (!attributes.hash) {\r\n        return false;\r\n    }\r\n\r\n    var calculatedHash = Crypto.calculatePayloadHash(options.payload, credentials.algorithm, res.headers['content-type']);\r\n    return (calculatedHash === attributes.hash);\r\n};\r\n\r\n\r\n// Generate a bewit value for a given URI\r\n\r\n/*\r\n    uri: 'http://example.com/resource?a=b' or object from Url.parse()\r\n    options: {\r\n\r\n        // Required\r\n\r\n        credentials: {\r\n            id: 'dh37fgj492je',\r\n            key: 'aoijedoaijsdlaksjdl',\r\n            algorithm: 'sha256'                             // 'sha1', 'sha256'\r\n        },\r\n        ttlSec: 60 * 60,                                    // TTL in seconds\r\n\r\n        // Optional\r\n\r\n        ext: 'application-specific',                        // Application specific data sent via the ext attribute\r\n        localtimeOffsetMsec: 400                            // Time offset to sync with server time\r\n    };\r\n*/\r\n\r\nexports.getBewit = function (uri, options) {\r\n\r\n    // Validate inputs\r\n\r\n    if (!uri ||\r\n        (typeof uri !== 'string' && typeof uri !== 'object') ||\r\n        !options ||\r\n        typeof options !== 'object' ||\r\n        !options.ttlSec) {\r\n\r\n        return '';\r\n    }\r\n\r\n    options.ext = (options.ext === null || options.ext === undefined ? '' : options.ext);       // Zero is valid value\r\n\r\n    // Application time\r\n\r\n    var now = Utils.now(options.localtimeOffsetMsec);\r\n\r\n    // Validate credentials\r\n\r\n    var credentials = options.credentials;\r\n    if (!credentials ||\r\n        !credentials.id ||\r\n        !credentials.key ||\r\n        !credentials.algorithm) {\r\n\r\n        return '';\r\n    }\r\n\r\n    if (Crypto.algorithms.indexOf(credentials.algorithm) === -1) {\r\n        return '';\r\n    }\r\n\r\n    // Parse URI\r\n\r\n    if (typeof uri === 'string') {\r\n        uri = Url.parse(uri);\r\n    }\r\n\r\n    // Calculate signature\r\n\r\n    var exp = Math.floor(now / 1000) + options.ttlSec;\r\n    var mac = Crypto.calculateMac('bewit', credentials, {\r\n        ts: exp,\r\n        nonce: '',\r\n        method: 'GET',\r\n        resource: uri.pathname + (uri.search || ''),                            // Maintain trailing '?'\r\n        host: uri.hostname,\r\n        port: uri.port || (uri.protocol === 'http:' ? 80 : 443),\r\n        ext: options.ext\r\n    });\r\n\r\n    // Construct bewit: id\\exp\\mac\\ext\r\n\r\n    var bewit = credentials.id + '\\\\' + exp + '\\\\' + mac + '\\\\' + options.ext;\r\n    return Hoek.base64urlEncode(bewit);\r\n};\r\n\r\n\r\n// Generate an authorization string for a message\r\n\r\n/*\r\n    host: 'example.com',\r\n    port: 8000,\r\n    message: '{\"some\":\"payload\"}',                          // UTF-8 encoded string for body hash generation\r\n    options: {\r\n\r\n        // Required\r\n\r\n        credentials: {\r\n            id: 'dh37fgj492je',\r\n            key: 'aoijedoaijsdlaksjdl',\r\n            algorithm: 'sha256'                             // 'sha1', 'sha256'\r\n        },\r\n\r\n        // Optional\r\n\r\n        timestamp: Date.now(),                              // A pre-calculated timestamp\r\n        nonce: '2334f34f',                                  // A pre-generated nonce\r\n        localtimeOffsetMsec: 400,                           // Time offset to sync with server time (ignored if timestamp provided)\r\n    }\r\n*/\r\n\r\nexports.message = function (host, port, message, options) {\r\n\r\n    // Validate inputs\r\n\r\n    if (!host || typeof host !== 'string' ||\r\n        !port || typeof port !== 'number' ||\r\n        message === null || message === undefined || typeof message !== 'string' ||\r\n        !options || typeof options !== 'object') {\r\n\r\n        return null;\r\n    }\r\n\r\n    // Application time\r\n\r\n    var timestamp = options.timestamp || Utils.nowSecs(options.localtimeOffsetMsec);\r\n\r\n    // Validate credentials\r\n\r\n    var credentials = options.credentials;\r\n    if (!credentials ||\r\n        !credentials.id ||\r\n        !credentials.key ||\r\n        !credentials.algorithm) {\r\n\r\n        // Invalid credential object\r\n        return null;\r\n    }\r\n\r\n    if (Crypto.algorithms.indexOf(credentials.algorithm) === -1) {\r\n        return null;\r\n    }\r\n\r\n    // Calculate signature\r\n\r\n    var artifacts = {\r\n        ts: timestamp,\r\n        nonce: options.nonce || Cryptiles.randomString(6),\r\n        host: host,\r\n        port: port,\r\n        hash: Crypto.calculatePayloadHash(message, credentials.algorithm)\r\n    };\r\n\r\n    // Construct authorization\r\n\r\n    var result = {\r\n        id: credentials.id,\r\n        ts: artifacts.ts,\r\n        nonce: artifacts.nonce,\r\n        hash: artifacts.hash,\r\n        mac: Crypto.calculateMac('message', credentials, artifacts)\r\n    };\r\n\r\n    return result;\r\n};\r\n\r\n\r\n\r\n"]}