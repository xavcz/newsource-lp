{"version":3,"sources":["multipart.js"],"names":[],"mappings":"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","file":"multipart-compiled.js","sourcesContent":["'use strict'\n\nvar uuid = require('node-uuid')\n  , CombinedStream = require('combined-stream')\n  , isstream = require('isstream')\n\n\nfunction Multipart (request) {\n  this.request = request\n  this.boundary = uuid()\n  this.chunked = false\n  this.body = null\n}\n\nMultipart.prototype.isChunked = function (options) {\n  var self = this\n    , chunked = false\n    , parts = options.data || options\n\n  if (!parts.forEach) {\n    self.request.emit('error', new Error('Argument error, options.multipart.'))\n  }\n\n  if (options.chunked !== undefined) {\n    chunked = options.chunked\n  }\n\n  if (self.request.getHeader('transfer-encoding') === 'chunked') {\n    chunked = true\n  }\n\n  if (!chunked) {\n    parts.forEach(function (part) {\n      if (typeof part.body === 'undefined') {\n        self.request.emit('error', new Error('Body attribute missing in multipart.'))\n      }\n      if (isstream(part.body)) {\n        chunked = true\n      }\n    })\n  }\n\n  return chunked\n}\n\nMultipart.prototype.setHeaders = function (chunked) {\n  var self = this\n\n  if (chunked && !self.request.hasHeader('transfer-encoding')) {\n    self.request.setHeader('transfer-encoding', 'chunked')\n  }\n\n  var header = self.request.getHeader('content-type')\n\n  if (!header || header.indexOf('multipart') === -1) {\n    self.request.setHeader('content-type', 'multipart/related; boundary=' + self.boundary)\n  } else {\n    if (header.indexOf('boundary') !== -1) {\n      self.boundary = header.replace(/.*boundary=([^\\s;]+).*/, '$1')\n    } else {\n      self.request.setHeader('content-type', header + '; boundary=' + self.boundary)\n    }\n  }\n}\n\nMultipart.prototype.build = function (parts, chunked) {\n  var self = this\n  var body = chunked ? new CombinedStream() : []\n\n  function add (part) {\n    if (typeof part === 'number') {\n      part = part.toString()\n    }\n    return chunked ? body.append(part) : body.push(new Buffer(part))\n  }\n\n  if (self.request.preambleCRLF) {\n    add('\\r\\n')\n  }\n\n  parts.forEach(function (part) {\n    var preamble = '--' + self.boundary + '\\r\\n'\n    Object.keys(part).forEach(function (key) {\n      if (key === 'body') { return }\n      preamble += key + ': ' + part[key] + '\\r\\n'\n    })\n    preamble += '\\r\\n'\n    add(preamble)\n    add(part.body)\n    add('\\r\\n')\n  })\n  add('--' + self.boundary + '--')\n\n  if (self.request.postambleCRLF) {\n    add('\\r\\n')\n  }\n\n  return body\n}\n\nMultipart.prototype.onRequest = function (options) {\n  var self = this\n\n  var chunked = self.isChunked(options)\n    , parts = options.data || options\n\n  self.setHeaders(chunked)\n  self.chunked = chunked\n  self.body = self.build(parts, chunked)\n}\n\nexports.Multipart = Multipart\n"]}