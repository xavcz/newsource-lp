{"version":3,"sources":["test-zlib-random-byte-pipes.js"],"names":[],"mappings":"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","file":"test-zlib-random-byte-pipes-compiled.js","sourcesContent":["// Copyright Joyent, Inc. and other Node contributors.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\nvar crypto = require('crypto');\nvar stream = require('stream');\nvar Stream = stream.Stream;\nvar util = require('util');\nvar tape = require('tape');\nvar zlib = require('../');\n\n\n\n// emit random bytes, and keep a shasum\nfunction RandomReadStream(opt) {\n  Stream.call(this);\n\n  this.readable = true;\n  this._paused = false;\n  this._processing = false;\n\n  this._hasher = crypto.createHash('sha1');\n  opt = opt || {};\n\n  // base block size.\n  opt.block = opt.block || 256 * 1024;\n\n  // total number of bytes to emit\n  opt.total = opt.total || 256 * 1024 * 1024;\n  this._remaining = opt.total;\n\n  // how variable to make the block sizes\n  opt.jitter = opt.jitter || 1024;\n\n  this._opt = opt;\n\n  this._process = this._process.bind(this);\n\n  process.nextTick(this._process);\n}\n\nutil.inherits(RandomReadStream, Stream);\n\nRandomReadStream.prototype.pause = function() {\n  this._paused = true;\n  this.emit('pause');\n};\n\nRandomReadStream.prototype.resume = function() {\n  this._paused = false;\n  this.emit('resume');\n  this._process();\n};\n\nRandomReadStream.prototype._process = function() {\n  if (this._processing) return;\n  if (this._paused) return;\n\n  this._processing = true;\n\n  if (!this._remaining) {\n    this._hash = this._hasher.digest('hex').toLowerCase().trim();\n    this._processing = false;\n\n    this.emit('end');\n    return;\n  }\n\n  // figure out how many bytes to output\n  // if finished, then just emit end.\n  var block = this._opt.block;\n  var jitter = this._opt.jitter;\n  if (jitter) {\n    block += Math.ceil(Math.random() * jitter - (jitter / 2));\n  }\n  block = Math.min(block, this._remaining);\n  var buf = new Buffer(block);\n  for (var i = 0; i < block; i++) {\n    buf[i] = Math.random() * 256;\n  }\n\n  this._hasher.update(buf);\n\n  this._remaining -= block;\n\n  this._processing = false;\n\n  this.emit('data', buf);\n  process.nextTick(this._process);\n};\n\n\n// a filter that just verifies a shasum\nfunction HashStream() {\n  Stream.call(this);\n\n  this.readable = this.writable = true;\n  this._hasher = crypto.createHash('sha1');\n}\n\nutil.inherits(HashStream, Stream);\n\nHashStream.prototype.write = function(c) {\n  // Simulate the way that an fs.ReadStream returns false\n  // on *every* write like a jerk, only to resume a\n  // moment later.\n  this._hasher.update(c);\n  process.nextTick(this.resume.bind(this));\n  return false;\n};\n\nHashStream.prototype.resume = function() {\n  this.emit('resume');\n  process.nextTick(this.emit.bind(this, 'drain'));\n};\n\nHashStream.prototype.end = function(c) {\n  if (c) {\n    this.write(c);\n  }\n  this._hash = this._hasher.digest('hex').toLowerCase().trim();\n  this.emit('data', this._hash);\n  this.emit('end');\n};\n\ntape('random byte pipes', function(t) {\n  var inp = new RandomReadStream({ total: 1024, block: 256, jitter: 16 });\n  var out = new HashStream();\n  var gzip = zlib.createGzip();\n  var gunz = zlib.createGunzip();\n\n  inp.pipe(gzip).pipe(gunz).pipe(out);\n\n  inp.on('data', function(c) {\n    t.ok(c.length);\n  });\n\n  gzip.on('data', function(c) {\n    t.ok(c.length);\n  });\n\n  gunz.on('data', function(c) {\n    t.ok(c.length);\n  });\n\n  out.on('data', function(c) {\n    t.ok(c.length);\n  });\n\n  out.on('data', function(c) {\n    t.ok(c.length);\n    t.equal(c, inp._hash, 'hashes should match');\n  });\n  \n  out.on('end', function() {\n    t.end();\n  })\n});\n\n"]}